# Build and Deploy Container Images
# Triggered after infrastructure changes or on demand

name: Build & Deploy

on:
  push:
    branches:
      - main
      - develop
      - uat
    paths-ignore:
      - "terraform/**"
      - ".github/workflows/terraform.yml"
      - "docs/**"
      - "*.md"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-secrets:
    name: Check Secrets Availability
    runs-on: ubuntu-latest
    outputs:
      has-azure-creds: ${{ steps.check.outputs.has-azure-creds }}
      has-clerk-publishable-key: ${{ steps.check.outputs.has-clerk-publishable-key }}
    steps:
      - name: Check if Azure credentials are available and valid
        id: check
        env:
          AZURE_CREDS: ${{ secrets.AZURE_CREDENTIALS }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
        run: |
          if [ -z "$AZURE_CREDS" ]; then
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "::warning::Azure credentials not configured. Skipping deployment."
          elif ! echo "$AZURE_CREDS" | jq empty 2>/dev/null; then
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "::warning::Azure credentials are not valid JSON. Skipping deployment."
          else
            CLIENT_ID=$(echo "$AZURE_CREDS" | jq -r '.clientId // empty')
            CLIENT_SECRET=$(echo "$AZURE_CREDS" | jq -r '.clientSecret // empty')
            SUBSCRIPTION_ID=$(echo "$AZURE_CREDS" | jq -r '.subscriptionId // empty')
            TENANT_ID=$(echo "$AZURE_CREDS" | jq -r '.tenantId // empty')

            if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$SUBSCRIPTION_ID" ] || [ -z "$TENANT_ID" ]; then
              echo "has-azure-creds=false" >> $GITHUB_OUTPUT
              echo "::warning::Azure credentials missing required fields. Skipping deployment."
            else
              echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            fi
          fi

          if [ -z "$CLERK_PUBLISHABLE_KEY" ]; then
            echo "has-clerk-publishable-key=false" >> $GITHUB_OUTPUT
            echo "::warning::CLERK_PUBLISHABLE_KEY not configured. Skipping deployment."
          else
            echo "has-clerk-publishable-key=true" >> $GITHUB_OUTPUT
          fi

  determine-environment:
    name: Determine Environment
    needs: check-secrets
    if: needs.check-secrets.outputs.has-azure-creds == 'true' && needs.check-secrets.outputs.has-clerk-publishable-key == 'true'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      resource_group: ${{ steps.set-env.outputs.resource_group }}
      acr_name: ${{ steps.set-env.outputs.acr_name }}
    steps:
      - name: Set environment from branch or input
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" == "refs/heads/uat" ]; then
            ENV="uat"
          else
            ENV="dev"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "resource_group=flowpost-${ENV}-rg" >> $GITHUB_OUTPUT
          echo "acr_name=flowpost${ENV}acr" >> $GITHUB_OUTPUT

  test:
    name: Run Tests
    needs: check-secrets
    if: needs.check-secrets.outputs.has-azure-creds == 'true' && needs.check-secrets.outputs.has-clerk-publishable-key == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint
        run: yarn lint

      - name: Type check
        run: yarn typecheck

      - name: Run tests
        run: yarn test --passWithNoTests

  build-backend:
    name: Build Backend
    needs: [determine-environment, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check if ACR exists
        id: check-acr
        run: |
          ACR_NAME="${{ needs.determine-environment.outputs.acr_name }}"
          if az acr show --name "$ACR_NAME" --query "name" -o tsv 2>/dev/null; then
            echo "ACR $ACR_NAME exists"
            echo "acr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ACR $ACR_NAME does not exist. Please ensure Terraform has been applied first."
            echo "acr_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Login to ACR
        if: steps.check-acr.outputs.acr_exists == 'true'
        run: |
          az acr login --name ${{ needs.determine-environment.outputs.acr_name }}

      - name: Build and push
        id: build
        run: |
          ACR_SERVER="${{ needs.determine-environment.outputs.acr_name }}.azurecr.io"
          IMAGE_TAG="${{ github.sha }}"

          docker build \
            -t ${ACR_SERVER}/flowpost-backend:${IMAGE_TAG} \
            -t ${ACR_SERVER}/flowpost-backend:latest \
            -f backend/Dockerfile .

          docker push ${ACR_SERVER}/flowpost-backend:${IMAGE_TAG}
          docker push ${ACR_SERVER}/flowpost-backend:latest

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

  build-frontend:
    name: Build Frontend
    needs: [determine-environment, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check if ACR exists
        id: check-acr
        run: |
          ACR_NAME="${{ needs.determine-environment.outputs.acr_name }}"
          if az acr show --name "$ACR_NAME" --query "name" -o tsv 2>/dev/null; then
            echo "ACR $ACR_NAME exists"
            echo "acr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ACR $ACR_NAME does not exist. Please ensure Terraform has been applied first."
            echo "acr_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Login to ACR
        if: steps.check-acr.outputs.acr_exists == 'true'
        run: |
          az acr login --name ${{ needs.determine-environment.outputs.acr_name }}

      - name: Build and push
        id: build
        run: |
          ACR_SERVER="${{ needs.determine-environment.outputs.acr_name }}.azurecr.io"
          IMAGE_TAG="${{ github.sha }}"

          docker build \
            --build-arg NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="${{ secrets.CLERK_PUBLISHABLE_KEY }}" \
            --build-arg NEXT_PUBLIC_ADMIN_USER_IDS="${{ secrets.ADMIN_USER_IDS }}" \
            -t ${ACR_SERVER}/flowpost-frontend:${IMAGE_TAG} \
            -t ${ACR_SERVER}/flowpost-frontend:latest \
            -f frontend/Dockerfile frontend/

          docker push ${ACR_SERVER}/flowpost-frontend:${IMAGE_TAG}
          docker push ${ACR_SERVER}/flowpost-frontend:latest

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy
    needs: [determine-environment, build-backend, build-frontend]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend
        run: |
          az containerapp update \
            --name flowpost-${{ needs.determine-environment.outputs.environment }}-backend \
            --resource-group ${{ needs.determine-environment.outputs.resource_group }} \
            --image ${{ needs.determine-environment.outputs.acr_name }}.azurecr.io/flowpost-backend:${{ needs.build-backend.outputs.image_tag }}

      - name: Deploy Frontend
        run: |
          az containerapp update \
            --name flowpost-${{ needs.determine-environment.outputs.environment }}-frontend \
            --resource-group ${{ needs.determine-environment.outputs.resource_group }} \
            --image ${{ needs.determine-environment.outputs.acr_name }}.azurecr.io/flowpost-frontend:${{ needs.build-frontend.outputs.image_tag }}

      - name: Get URLs
        id: urls
        run: |
          BACKEND_URL=$(az containerapp show \
            --name flowpost-${{ needs.determine-environment.outputs.environment }}-backend \
            --resource-group ${{ needs.determine-environment.outputs.resource_group }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          FRONTEND_URL=$(az containerapp show \
            --name flowpost-${{ needs.determine-environment.outputs.environment }}-frontend \
            --resource-group ${{ needs.determine-environment.outputs.resource_group }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "backend_url=https://${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "frontend_url=https://${FRONTEND_URL}" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.urls.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.urls.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY
